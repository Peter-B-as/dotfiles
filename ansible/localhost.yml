---
- name: Operation: Spider-Verse Restore (Arch Linux Setup)
  hosts: localhost
  connection: local
  become: yes  # åŸºæœ¬çš„ã«sudoæ¨©é™ã§å‹•ãã‚ˆ

  vars:
    # â–¼ ã“ã“ã‚’è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã«å¤‰ãˆã¦ã­ï¼
    target_user: peter
    # ãƒ‰ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å ´æ‰€
    dotfiles_dir: "/home/{{ target_user }}/dotfiles"

  tasks:
    # ======================================================
    # Phase 1: ã‚·ã‚¹ãƒ†ãƒ ã®åŸºç¤å·¥äº‹ (System Update)
    # ======================================================
    - name: ğŸ•·ï¸ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ›´æ–°ã¨ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰
      pacman:
        update_cache: yes
        upgrade: yes

    - name: ğŸ•·ï¸ ãƒ“ãƒ«ãƒ‰ã«å¿…è¦ãªãƒ™ãƒ¼ã‚¹ãƒ„ãƒ¼ãƒ«ã‚’å…¥ã‚Œã‚‹
      pacman:
        name:
          - base-devel
          - git
          - ansible
        state: present

    # ======================================================
    # Phase 2: AURãƒ˜ãƒ«ãƒ‘ãƒ¼ "Yay" ã®å°å…¥ (ã¡ã‚‡ã£ã¨ç‰¹æ®Š)
    # ======================================================
    - name: ğŸ•·ï¸ YayãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
      command: which yay
      register: yay_check
      ignore_errors: yes
      changed_when: false

    - name: ğŸ•·ï¸ Yayã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (ãªã„å ´åˆã®ã¿)
      block:
        - name: Yayã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
          git:
            repo: 'https://aur.archlinux.org/yay.git'
            dest: "/home/{{ target_user }}/yay-temp"
            version: master
          become: yes
          become_user: "{{ target_user }}" # ã“ã“ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã§ã‚„ã‚‹ï¼ˆmakepkgã®ãŸã‚ï¼‰

        - name: Yayã‚’ãƒ“ãƒ«ãƒ‰ï¼†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          command: "makepkg -si --noconfirm"
          args:
            chdir: "/home/{{ target_user }}/yay-temp"
          become: yes
          become_user: "{{ target_user }}"

        - name: ä¸€æ™‚ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãŠæƒé™¤
          file:
            path: "/home/{{ target_user }}/yay-temp"
            state: absent
      when: yay_check.rc != 0

    # ======================================================
    # Phase 3: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸€æ‹¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    # ======================================================
    - name: ğŸ•·ï¸ pkglist.txt ã‹ã‚‰ã‚¢ãƒ—ãƒªã‚’ä¸€æ‹¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      # ãƒªã‚¹ãƒˆå†…ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒ«ãƒ¼ãƒ—ã§å›ã™
      pacman:
        name: "{{ item }}"
        state: present
      # pkglist.txtã‚’è¡Œã”ã¨ã«èª­ã¿è¾¼ã‚€
      loop: "{{ lookup('file', dotfiles_dir + '/pkglist.txt').splitlines() }}"
      ignore_errors: yes # ä¸‡ãŒä¸€ãƒªã‚¹ãƒˆã«å¤‰ãªåå‰ãŒã‚ã£ã¦ã‚‚æ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹

    # ======================================================
    # Phase 4: ãƒ‰ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªãƒ³ã‚¯ (Web-Shooter Link)
    # ======================================================
    - name: ğŸ•·ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
      file:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        state: link
        force: yes # ã™ã§ã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸Šæ›¸ãï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ã¯ãªã„ã®ã§æ³¨æ„ï¼‰
      loop:
        # â–¼ ã“ã“ã«ãƒªãƒ³ã‚¯ã—ãŸã„ã‚‚ã®ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ã
        - { src: "{{ dotfiles_dir }}/.zshrc", dest: "/home/{{ target_user }}/.zshrc" }
        - { src: "{{ dotfiles_dir }}/.p10k.zsh", dest: "/home/{{ target_user }}/.p10k.zsh" }
        - { src: "{{ dotfiles_dir }}/.gitconfig", dest: "/home/{{ target_user }}/.gitconfig" }
        # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨ã®ãƒªãƒ³ã‚¯
        - { src: "{{ dotfiles_dir }}/.config/nvim", dest: "/home/{{ target_user }}/.config/nvim" }
        - { src: "{{ dotfiles_dir }}/.config/fcitx5", dest: "/home/{{ target_user }}/.config/fcitx5" }
        - { src: "{{ dotfiles_dir }}/.config/gh/config.yml", dest: "/home/{{ target_user }}/.config/gh/config.yml" }
        # å¿…è¦ãªã‚‰ã“ã“ã«è¡Œã‚’è¿½åŠ ã—ã¦ã„ã‘ã°ã„ã„
      become: yes
      become_user: "{{ target_user }}" # ãƒªãƒ³ã‚¯ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã§ä½œã‚‹ï¼

    # ======================================================
    # Phase 5: ä»•ä¸Šã’ (Final Polish)
    # ======================================================
    - name: ğŸ•·ï¸ ãƒ­ã‚°ã‚¤ãƒ³ã‚·ã‚§ãƒ«ã‚’Zshã«å¤‰æ›´
      user:
        name: "{{ target_user }}"
        shell: /bin/zsh

    - name: ğŸ•·ï¸ å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      debug:
        msg: "Mission Accomplished! ã‚¹ãƒ‘ã‚¤ãƒ€ãƒ¼ãƒ»ãƒ‘ã‚½ã‚³ãƒ³ã®æ§‹ç¯‰å®Œäº†ã€‚å†èµ·å‹•ã—ã¦ã­ï¼"
