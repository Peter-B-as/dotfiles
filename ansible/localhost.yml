---
- name: Project Resurrection: Ultimate Arch Setup (Spider-Edition)
  hosts: localhost
  connection: local
  become: yes  # åŸºæœ¬ã¯rootæ¨©é™

  vars:
    # â–¼ è‡ªåˆ†ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å
    target_user: peter
    dotfiles_dir: "/home/{{ target_user }}/dotfiles"

  tasks:
    # ======================================================
    # Phase 1: ãƒ™ãƒ¼ã‚¹ã‚·ã‚¹ãƒ†ãƒ ã®å¼·åŒ–
    # ======================================================
    - name: ğŸ•·ï¸ ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®æ›´æ–° (pacman -Syu)
      pacman:
        update_cache: yes
        upgrade: yes

    - name: ğŸ•·ï¸ å¿…é ˆãƒ„ãƒ¼ãƒ«ã¨Syncthingã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      pacman:
        name:
          - base-devel
          - git
          - ansible
          - neovim
          - zsh
          - syncthing
        state: present

    # ======================================================
    # Phase 2: AURãƒ˜ãƒ«ãƒ‘ãƒ¼ "Yay" ã®å¬å–š
    # ======================================================
    - name: ğŸ•·ï¸ Yayã®å­˜åœ¨ç¢ºèª
      command: which yay
      register: yay_check
      ignore_errors: yes
      changed_when: false

    - name: ğŸ•·ï¸ Yayã‚’ãƒ“ãƒ«ãƒ‰ï¼†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (å­˜åœ¨ã—ãªã„å ´åˆã®ã¿)
      block:
        - name: Yayã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
          git:
            repo: 'https://aur.archlinux.org/yay.git'
            dest: "/home/{{ target_user }}/yay-temp"
            version: master
          become: yes
          become_user: "{{ target_user }}"

        - name: ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
          command: "makepkg -si --noconfirm"
          args:
            chdir: "/home/{{ target_user }}/yay-temp"
          become: yes
          become_user: "{{ target_user }}"

        - name: ãŠæƒé™¤
          file:
            path: "/home/{{ target_user }}/yay-temp"
            state: absent
      when: yay_check.rc != 0

    # ======================================================
    # Phase 3: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¸€æ‹¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (å›ã®æ”¹è‰¯ç‰ˆï¼)
    # ======================================================
    - name: ğŸ•·ï¸ pkglist.txt ã‚’èª­ã¿è¾¼ã‚€
      set_fact:
        pkg_list: "{{ lookup('file', dotfiles_dir + '/pkglist.txt').splitlines() }}"

    # â˜…ã“ã“ãŒé‡è¦ï¼Yayå®Ÿè¡Œå‰ã«sudoã®èªè¨¼æƒ…å ±ã‚’æ›´æ–°ã—ã¦ãŠã
    # Yayã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã§å‹•ããŒã€å†…éƒ¨ã§sudoã‚’å©ããŸã‚ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’èã‹ã‚Œã‚‹ã¨æ­¢ã¾ã£ã¦ã—ã¾ã†
    # ã“ã®ã‚¿ã‚¹ã‚¯ã§sudoã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¦ãŠã
    - name: ğŸ•·ï¸ Sudoæ¨©é™ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
      command: sudo -v
      become: yes
      become_user: "{{ target_user }}"

    - name: ğŸ•·ï¸ å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä¸€æ‹¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« (Yayã‚’ä½¿ç”¨)
      # --answerdiff=None ç­‰ã‚’è¿½åŠ ã—ã¦ã€Diffç¢ºèªã®åœæ­¢ã‚’å¾¹åº•
      command: "yay -S --noconfirm --needed --answerdiff=None --answerclean=None {{ pkg_list | join(' ') }}"
      become: yes
      become_user: "{{ target_user }}"
      async: 3600
      poll: 30
    # ======================================================
    # Phase 4: ãƒ‰ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªãƒ³ã‚¯æ¥ç¶š
    # ======================================================
    - name: ğŸ•·ï¸ Configç”¨ã®è¦ªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
      file:
        path: "{{ item }}"
        state: directory
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
      loop:
        - "/home/{{ target_user }}/.config/gh"
        - "/home/{{ target_user }}/.config/keepassxc"
        - "/home/{{ target_user }}/.config/nvim"

    - name: ğŸ•·ï¸ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
      file:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        state: link
        force: yes
        owner: "{{ target_user }}"
        group: "{{ target_user }}"
      loop:
        - { src: "{{ dotfiles_dir }}/.zshrc", dest: "/home/{{ target_user }}/.zshrc" }
        - { src: "{{ dotfiles_dir }}/.p10k.zsh", dest: "/home/{{ target_user }}/.p10k.zsh" }
        - { src: "{{ dotfiles_dir }}/.gitconfig", dest: "/home/{{ target_user }}/.gitconfig" }
        - { src: "{{ dotfiles_dir }}/.config/fcitx5", dest: "/home/{{ target_user }}/.config/fcitx5" }
        - { src: "{{ dotfiles_dir }}/.config/nvim", dest: "/home/{{ target_user }}/.config/nvim" }
        - { src: "{{ dotfiles_dir }}/.config/gh/config.yml", dest: "/home/{{ target_user }}/.config/gh/config.yml" }
        - { src: "{{ dotfiles_dir }}/.config/keepassxc/keepassxc.ini", dest: "/home/{{ target_user }}/.config/keepassxc/keepassxc.ini" }

    # ======================================================
    # Phase 5: ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹• & ä»•ä¸Šã’ (UIDä¿®æ­£ç‰ˆ)
    # ======================================================
    
    # ã€NEW!ã€‘ç¢ºå®Ÿã«ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®UIDã‚’å–å¾—ã™ã‚‹
    - name: ğŸ•·ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ID (UID) ã‚’å–å¾—
      command: "id -u {{ target_user }}"
      register: target_uid
      changed_when: false

    - name: ğŸ•·ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ã‚§ãƒ«ã‚’Zshã«å¤‰æ›´
      user:
        name: "{{ target_user }}"
        shell: /bin/zsh

    - name: ğŸ•·ï¸ Syncthingã‚µãƒ¼ãƒ“ã‚¹ã‚’æœ‰åŠ¹åŒ– (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ãƒ™ãƒ«)
      systemd:
        name: syncthing
        scope: user
        state: started
        enabled: yes
      become: yes
      become_user: "{{ target_user }}"
      environment:
        # å–å¾—ã—ãŸUIDã‚’ã“ã“ã§ä½¿ã†ï¼
        XDG_RUNTIME_DIR: "/run/user/{{ target_uid.stdout }}"

    - name: ğŸ•·ï¸ å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      debug:
        msg: "Mission Accomplished! ğŸ•·ï¸ Archç’°å¢ƒã®å®Œå…¨å¾©æ´»ã‚’ç¢ºèªã€‚Good job, Spidey!"